<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashFarm - Sistema Integrado DG500</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a;
            --main-bg: #f1f5f9;
            --accent: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --whatsapp: #25d366;
            --card-bg: #ffffff;
        }

        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: var(--main-bg); }
        body { display: flex; }

        /* SIDEBAR */
        .sidebar {
            width: 260px; background-color: var(--sidebar-bg); color: white;
            padding: 20px 15px; display: flex; flex-direction: column; gap: 12px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); flex-shrink: 0;
        }

        .logo h1 { font-size: 20px; font-weight: 800; margin: 0; color: var(--accent); }
        .logo p { font-size: 10px; margin: 2px 0 0; color: #94a3b8; text-transform: uppercase; font-weight: bold; }

        .nav-tabs { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; }
        .nav-btn {
            background: rgba(255,255,255,0.05); border: none; color: #cbd5e1;
            padding: 12px; border-radius: 8px; cursor: pointer; text-align: left;
            font-weight: 700; font-size: 13px; transition: 0.3s;
        }
        .nav-btn.active { background: var(--accent); color: white; }

        .upload-area {
            background: #1e293b; border: 1px dashed #334155;
            padding: 12px; border-radius: 8px; text-align: center; cursor: pointer;
        }

        .filter-item { display: flex; flex-direction: column; gap: 4px; }
        .filter-item label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }

        input, select {
            background: #1e293b; border: 1px solid #334155; color: white;
            padding: 10px; border-radius: 6px; font-size: 12px; width: 100%; box-sizing: border-box;
        }

        .btn-clear { background: #334155; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 11px; margin-top: 5px; }
        .btn-clear:hover { background: var(--danger); }

        .wa-section { margin-top: 10px; padding-top: 15px; border-top: 1px solid #334155; display: flex; flex-direction: column; gap: 8px; }
        .btn-whatsapp { background: var(--whatsapp); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 12px; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .view-pane { display: none; flex-direction: column; height: 100%; }
        .view-pane.active { display: flex; }

        /* DASHBOARD DI√ÅRIO COMPACTO */
        .top-row { display: grid; grid-template-columns: 260px 1fr; gap: 20px; margin-bottom: 20px; flex-shrink: 0; }
        .info-box { background: white; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .gauge-container { width: 100%; height: 90px; position: relative; }
        .gauge-text { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: 900; }

        .master-card { 
            background: white; border-radius: 12px; border: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; 
            height: 420px; /* ALTURA FIXA PARA MANTER COMPACTO */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; 
        }
        .master-header { padding: 12px 25px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: grid; grid-template-columns: 140px 1fr 180px; gap: 20px; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .scrollable-body { overflow-y: scroll; flex: 1; }

        /* ROLAGEM ELEGANTE */
        .scrollable-body::-webkit-scrollbar { width: 8px; }
        .scrollable-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .day-summary { display: grid; grid-template-columns: 140px 1fr 180px; gap: 20px; align-items: center; padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
        .day-details { background: #fdfdfd; padding: 5px 25px 15px 40px; display: none; border-bottom: 2px solid #eee; }
        .file-row { display: grid; grid-template-columns: 180px 120px 1fr 100px; font-size: 12px; padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .time-badge { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 11px; }

        /* DASHBOARD INGREDIENTES */
        .grid-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px 0; overflow-y: auto; }
        .card-ing { background: white; border-radius: 12px; padding: 18px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.8); display:none; justify-content:center; align-items:center; z-index: 2000; }
        .modal-content { background: white; border-radius: 16px; width: 600px; max-height: 80vh; padding: 25px; display: flex; flex-direction: column; }
        .progress-bg { height: 10px; background: #e2e8f0; border-radius: 5px; flex: 1; overflow: hidden; margin-right: 12px; }
        .progress-fill { height: 100%; transition: width 0.6s; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><h1>DashFarm</h1><p>Gest√£o Profissional</p></div>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchView('daily', this)">üìÖ Dashboard Di√°rio</button>
            <button class="nav-btn" onclick="switchView('ingredients', this)">üìä Ingredientes</button>
        </div>
        <label class="upload-area"><span style="font-size:11px; color:#cbd5e1; cursor:pointer; font-weight: 700;">üìÅ CARREGAR CSVs</span><input type="file" id="folder-input" webkitdirectory directory multiple style="display:none"></label>
        <div class="filter-item"><label>In√≠cio:</label><input type="date" id="date-start" onchange="render()"></div>
        <div class="filter-item"><label>Fim:</label><input type="date" id="date-end" onchange="render()"></div>
        <div class="filter-item"><label>Receita:</label><select id="recipe-select" onchange="render()"></select></div>
        <button class="btn-clear" onclick="clearFilters()">LIMPAR FILTROS</button>
        <div class="wa-section">
            <div class="filter-item"><label>WhatsApp Gestor</label><input type="text" id="wa-number" placeholder="(00) 00000-0000" maxlength="15"></div>
            <button class="btn-whatsapp" onclick="sendWhatsApp()">ENVIAR AUDITORIA üì≤</button>
        </div>
        <div id="status-msg" style="margin-top:auto; font-size:11px; color:var(--success); font-weight:700;">Aguardando...</div>
    </div>

    <div class="main-content">
        <div id="view-daily" class="view-pane active">
            <div class="top-row">
                <div class="info-box"><div class="gauge-container"><canvas id="main-gauge"></canvas><div class="gauge-text" id="gauge-val">0%</div></div></div>
                <div class="info-box"><div style="height:120px;"><canvas id="daily-bar-chart"></canvas></div></div>
            </div>
            <div class="master-card">
                <div class="master-header"><div>Data</div><div>Acertividade M√©dia</div><div style="text-align: right;">Total Real</div></div>
                <div id="list-container" class="scrollable-body"></div>
            </div>
        </div>

        <div id="view-ingredients" class="view-pane">
            <h2 style="margin-top:0;">An√°lise por Ingrediente</h2>
            <div class="grid-cards" id="ing-container"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:2px solid #f1f5f9; padding-bottom:10px;">
                <div><h2 id="modal-filename" style="margin:0; font-size:20px;">Arquivo</h2><span id="modal-time" style="color:var(--accent); font-weight:700;"></span></div>
                <div style="cursor:pointer; font-size:30px;" onclick="closeModal()">&times;</div>
            </div>
            <div style="overflow-y:auto;"><table style="width:100%; border-collapse:collapse; font-size:14px;"><thead style="background:#f8fafc;"><tr><th style="text-align:left; padding:12px">Item</th><th>Ped.</th><th>Real</th><th>Dif.</th></tr></thead><tbody id="modal-items-body"></tbody></table></div>
        </div>
    </div>

    <script>
        let fileDatabase = [];
        let mainGauge = null, mainBarChart = null;
        const ingredientMap = { 'M': 'MANDIOCA', 'L': 'LARANJA' };
        const recipeMap = { '1': 'Engorda', '2': 'Adapta√ß√£o', '3': 'Bezerro' };

        function switchView(viewId, btn) {
            document.querySelectorAll('.view-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            btn.classList.add('active');
            render();
        }

        function clearFilters() {
            if (!fileDatabase.length) return;
            const dates = fileDatabase.map(d => d.date).sort();
            document.getElementById('date-start').value = dates[0];
            document.getElementById('date-end').value = dates[dates.length - 1];
            document.getElementById('recipe-select').value = "ALL";
            render();
        }

        document.getElementById('wa-number').addEventListener('input', (e) => {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });

        document.getElementById('folder-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.csv'));
            fileDatabase = [];
            document.getElementById('status-msg').innerText = "Processando arquivos...";
            for (const file of files) {
                await new Promise(resolve => {
                    Papa.parse(file, { delimiter: ";", encoding: "ISO-8859-1", skipEmptyLines: true,
                        complete: function(res) { parseFile(res.data, file.name); resolve(); }
                    });
                });
            }
            setupUI();
        });

        function parseFile(rows, fileName) {
            let recipe = null, time = "", items = [], pTot = 0, rTot = 0;
            rows.forEach((row, i) => {
                if (row[0]?.toLowerCase().includes("dados da receita")) {
                    const dr = rows[i+2];
                    if (dr && dr[3]) {
                        const d = dr[3].split('/');
                        recipe = { id: dr[1].trim(), date: `${d[2]}-${d[1].padStart(2,'0')}-${d[0].padStart(2,'0')}` };
                        time = dr[4] || "00:00";
                    }
                }
                if (row[0]?.toLowerCase().includes("dados dos componentes")) {
                    let j = i+2;
                    while(rows[j] && !isNaN(rows[j][0]) && rows[j][0] !== "") {
                        let p = parseFloat(rows[j][2].replace(',','.')) || 0;
                        let r = parseFloat(rows[j][3].replace(',','.')) || 0;
                        let n = rows[j][1].trim().toUpperCase();
                        items.push({ name: ingredientMap[n] || n, p, r });
                        pTot += p; rTot += r; j++;
                    }
                }
            });
            if (recipe && pTot > 0) fileDatabase.push({ fileName, time, date: recipe.date, id: recipe.id, p: pTot, r: rTot, items, acc: Math.max(0, 100 - (Math.abs((rTot - pTot) / pTot) * 100)) });
        }

        function setupUI() {
            if (!fileDatabase.length) return;
            const dates = fileDatabase.map(d => d.date).sort();
            document.getElementById('date-start').value = dates[0];
            document.getElementById('date-end').value = dates[dates.length - 1];
            const ids = [...new Set(fileDatabase.map(d => d.id))].sort((a,b) => a-b);
            document.getElementById('recipe-select').innerHTML = '<option value="ALL">Todas</option>' + ids.map(id => `<option value="${id}">${id} - ${recipeMap[id] || 'Rec'}</option>`).join('');
            document.getElementById('status-msg').innerText = "Carga completa.";
            render();
        }

        function render() {
            const start = document.getElementById('date-start').value;
            const end = document.getElementById('date-end').value;
            const selId = document.getElementById('recipe-select').value;
            let filtered = fileDatabase.filter(d => d.date >= start && d.date <= end && (selId === "ALL" || d.id === selId));
            const daily = {};
            filtered.forEach(f => {
                if (!daily[f.date]) daily[f.date] = { p: 0, r: 0, files: [] };
                daily[f.date].p += f.p; daily[f.date].r += f.r; daily[f.date].files.push(f);
            });
            const labels = Object.keys(daily).sort();
            updateDailyDashboard(filtered, labels, daily);
            updateIngredientsDashboard(filtered);
        }

        function updateDailyDashboard(filtered, labels, daily) {
            const pArr = filtered.reduce((a,b)=>a+b.p,0), rArr = filtered.reduce((a,b)=>a+b.r,0);
            const totalAcc = pArr > 0 ? Math.max(0, 100 - (Math.abs((rArr - pArr) / pArr) * 100)) : 0;
            document.getElementById('gauge-val').innerText = totalAcc.toFixed(1) + '%';
            if (mainGauge) mainGauge.destroy();
            mainGauge = new Chart(document.getElementById('main-gauge').getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [totalAcc, 100-totalAcc], backgroundColor: [totalAcc >= 95 ? '#10b981':'#ef4444'], borderWidth:0, circumference:180, rotation:270, cutout:'85%' }] }, options: { maintainAspectRatio:false, plugins: {tooltip:{enabled:false}} } });
            if (mainBarChart) mainBarChart.destroy();
            mainBarChart = new Chart(document.getElementById('daily-bar-chart').getContext('2d'), { type: 'bar', data: { labels: labels.map(l => l.split('-').reverse().slice(0, 2).join('/')), datasets: [{ data: labels.map(l => Math.max(0, 100 - (Math.abs((daily[l].r - daily[l].p) / daily[l].p) * 100))), backgroundColor: labels.map(l => (Math.max(0, 100 - (Math.abs((daily[l].r - daily[l].p) / daily[l].p) * 100))) >= 95 ? '#10b981' : '#ef4444') }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 70, max: 100 } } } });
            document.getElementById('list-container').innerHTML = labels.reverse().map(date => {
                const d = daily[date]; const acc = Math.max(0, 100 - (Math.abs((d.r - d.p) / d.p) * 100));
                const dateId = date.replace(/-/g,'');
                return `<div class="day-group">
                    <div class="day-summary" onclick="const e=document.getElementById('details-${dateId}'); e.style.display=e.style.display==='block'?'none':'block'">
                        <span style="font-weight:800;">${date.split('-').reverse().join('/')}</span>
                        <div style="display:flex; align-items:center"><div class="progress-bg"><div class="progress-fill" style="width:${acc}%; background:${acc >= 95 ? 'var(--success)':'var(--danger)'}"></div></div> <b>${acc.toFixed(1)}%</b></div>
                        <div style="text-align:right"><b>${Math.round(d.r).toLocaleString()} kg</b></div>
                    </div>
                    <div class="day-details" id="details-${dateId}">${d.files.map(f => `<div class="file-row" onclick="openModal('${f.fileName}')"><span style="color:var(--accent); font-weight:700;">üìÑ ${f.fileName}</span><span class="time-badge">üïí ${f.time}</span><div style="display:flex; align-items:center; gap:5px;"><div class="progress-bg" style="width:50px; height:6px;"><div class="progress-fill" style="width:${f.acc}%; background:${f.acc >= 95 ? 'var(--success)':'var(--danger)'}"></div></div><span>${f.acc.toFixed(1)}%</span></div><div style="text-align:right"><b>${Math.round(f.r)}kg</b></div></div>`).join('')}</div>
                </div>`;
            }).join('');
        }

        function updateIngredientsDashboard(filtered) {
            const ingTotals = {};
            filtered.forEach(f => f.items.forEach(it => { if(!ingTotals[it.name]) ingTotals[it.name] = { p: 0, r: 0 }; ingTotals[it.name].p += it.p; ingTotals[it.name].r += it.r; }));
            document.getElementById('ing-container').innerHTML = Object.keys(ingTotals).sort().map(name => {
                const d = ingTotals[name]; const diff = d.r - d.p; const acc = d.p > 0 ? Math.max(0, 100 - (Math.abs(diff/d.p)*100)) : 0;
                return `<div class="card-ing"><div style="display:flex; justify-content:space-between;"><span class="comp-name">${name}</span><span style="font-size:10px; font-weight:900; padding:4px 8px; border-radius:4px; background:${acc>=95?'#dcfce7':'#fee2e2'}; color:${acc>=95?'#15803d':'#b91c1c'}">${acc.toFixed(1)}%</span></div>
                    <div style="display:flex; justify-content:space-between; font-size:13px; margin-top:8px;"><span>Pedido:</span><b>${Math.round(d.p).toLocaleString()} kg</b></div>
                    <div style="display:flex; justify-content:space-between; font-size:13px;"><span>Real:</span><b>${Math.round(d.r).toLocaleString()} kg</b></div>
                    <div style="border-top:1px solid #eee; padding-top:8px; margin-top:8px; display:flex; justify-content:space-between; font-weight:800;"><span>Dif:</span><span style="color:${diff>0?'red':'blue'}">${diff>0?'+':''}${Math.round(diff).toLocaleString()} kg</span></div></div>`;
            }).join('');
        }

        function sendWhatsApp() {
            const num = document.getElementById('wa-number').value.replace(/\D/g, '');
            if (num.length < 10) return alert("Insira um n√∫mero!");
            const start = document.getElementById('date-start').value.split('-').reverse().join('/');
            const end = document.getElementById('date-end').value.split('-').reverse().join('/');
            let criticos = "";
            fileDatabase.forEach(f => { if(f.acc < 95) criticos += `‚ùå ${f.date.split('-').reverse().join('/')} - ${f.fileName}: ${f.acc.toFixed(1)}%\n`; });
            const msg = window.encodeURIComponent(`üìä *AUDITORIA DG500*\nüìÖ Per√≠odo: ${start} a ${end}\n\n${criticos || "‚úÖ Tudo OK!"}\n_Gerado via DashFarm._`);
            window.open(`https://api.whatsapp.com/send?phone=55${num}&text=${msg}`, '_blank');
        }

        function openModal(name) {
            const f = fileDatabase.find(x => x.fileName === name);
            document.getElementById('modal-filename').innerText = "üìÑ " + f.fileName;
            document.getElementById('modal-time').innerText = "Hora: " + f.time;
            document.getElementById('modal-items-body').innerHTML = f.items.map(i => `<tr><td style="padding:12px; font-weight:600;">${i.name}</td><td>${Math.round(i.p)}</td><td>${Math.round(i.r)}</td><td style="color:${i.r-i.p>0?'red':'blue'}">${Math.round(i.r-i.p)}kg</td></tr>`).join('');
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
    </script>
</body>
</html>
