<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DashFarm Pro - Auditoria de Precis√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a;
            --main-bg: #f1f5f9;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        /* RESET & MOBILE FIX */
        html, body { 
            height: 100%; margin: 0; padding: 0;
            font-family: 'Inter', sans-serif; 
            background-color: var(--main-bg); 
            overflow: hidden; 
            -webkit-text-size-adjust: 100%;
        }
        body { display: flex; flex-direction: row; }

        /* SIDEBAR ADAPT√ÅVEL */
        .sidebar {
            width: 180px; background-color: var(--sidebar-bg); color: white;
            padding: 15px; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;
            box-shadow: 4px 0 15px rgba(0,0,0,0.2); overflow-y: auto;
            z-index: 100;
        }
        .logo h1 { font-size: 18px; font-weight: 900; color: var(--accent); margin: 0; }
        .logo p { font-size: 8px; color: #94a3b8; margin: 0; text-transform: uppercase; }

        .upload-area { background: #1e293b; border: 1px dashed #334155; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; }
        
        /* ESPA√áO PARA LOGO (SUBSTITUINDO WHATSAPP) */
        .brand-area {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }
        .brand-area img { 
            max-width: 100%; 
            max-height: 110px; 
            object-fit: contain;
            -webkit-filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .field-group { display: flex; flex-direction: column; gap: 4px; }
        .field-group label { font-size: 8px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; font-size: 11px; width: 100%; box-sizing: border-box; outline: none; }

        .btn-accent { background: var(--accent); border: none; padding: 10px; border-radius: 6px; font-weight: 800; cursor: pointer; font-size: 10px; color: white; width: 100%; }

        /* CONTE√öDO PRINCIPAL SCROLL√ÅVEL NO MOBILE */
        .main-container { 
            flex: 1; display: flex; flex-direction: column; gap: 10px; 
            padding: 10px; height: 100vh; overflow-y: auto; 
            box-sizing: border-box; -webkit-overflow-scrolling: touch;
        }

        /* GAUGES COMPACTOS */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; }
        .kpi-card { background: white; border-radius: 12px; padding: 8px; display: flex; flex-direction: column; align-items: center; border: 1px solid #e2e8f0; position: relative; height: 110px; }
        .kpi-card label { font-size: 9px; font-weight: 900; color: var(--text-muted); text-transform: uppercase; }
        .kpi-value { position: absolute; bottom: 8px; font-size: 15px; font-weight: 900; }

        /* RECEITAS */
        .recipe-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; flex-shrink: 0; }
        .recipe-card { background: white; border-radius: 10px; border: 1px solid #e2e8f0; overflow: hidden; }
        .card-header { background: var(--sidebar-bg); color: white; padding: 6px; text-align: center; }
        .card-header h2 { margin: 0; font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--accent); }
        
        .table-wrap { padding: 4px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 7px; text-align: center; }
        td { padding: 3px 2px; border-bottom: 1px solid #f1f5f9; font-weight: 700; white-space: nowrap; }

        /* GRAFICO */
        .chart-section { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 10px; min-height: 180px; display: flex; flex-direction: column; flex-shrink: 0; }

        /* MATRIZ DE ASSERTIVIDADE */
        .assertivity-section { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 10px; flex-shrink: 0; margin-bottom: 20px; }
        .matrix-scroll { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        .matrix-table { font-size: 6.5px; min-width: 500px; border-spacing: 2px; border-collapse: separate; }
        .matrix-table th { background: #0f172a; color: white; padding: 4px; border-radius: 3px; }
        .hour-col { background: #f8fafc !important; color: #0f172a !important; font-weight: 900; width: 60px; }
        .cell-high { background: #3b82f6; color: white; border-radius: 3px; }
        .cell-mid { background: #ffffff; color: var(--text-main); border: 1px solid #e2e8f0; border-radius: 3px; }
        .cell-low { background: #fecaca; color: #b91c1c; border-radius: 3px; }

        /* MEDIA QUERIES PARA CELULAR */
        @media (max-width: 600px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 2px solid var(--accent); }
            .main-container { height: auto; overflow: visible; }
            .recipe-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><h1>DashFarm</h1><p>Manejo de Precis√£o</p></div>
        
        <label class="upload-area">
            <span style="font-size: 8px; font-weight: 800; color: #cbd5e1;">üìÅ CARREGAR CSV</span>
            <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none">
        </label>

        <div class="brand-area">
            <img src="logo.png" alt="Logo" onerror="this.style.opacity='0.2';">
        </div>
        
        <div class="field-group"><label>Dia √önico:</label><input type="date" id="date-single" onchange="applySingleDate()"></div>
        <div class="field-group"><label>Per√≠odo:</label><input type="date" id="date-start" onchange="applyRangeDate()"><input type="date" id="date-end" onchange="applyRangeDate()" style="margin-top:2px"></div>
        <button class="btn-accent" onclick="clearFilters()">LIMPAR TUDO</button>

        <div id="status-msg" style="font-size:7px; color:var(--success); margin-top: auto; text-align: center;">Sistema Ativo</div>
    </div>

    <div class="main-container">
        <div class="kpi-row">
            <div class="kpi-card"><label>Efici√™ncia Geral</label><canvas id="gaugeEff"></canvas><div id="valEff" class="kpi-value">0%</div></div>
            <div class="kpi-card"><label>Perda Total</label><canvas id="gaugeLoss"></canvas><div id="valLoss" class="kpi-value">R$ 0</div></div>
        </div>

        <div class="recipe-grid">
            <div class="recipe-card"><div class="card-header"><h2>Engorda</h2><div id="meta-1" style="font-size:7px; color:#cbd5e1;">0 Tratos</div><span id="loss-1" style="font-size:10px; color:#ffbcbc; font-weight:900;">R$ 0</span></div>
            <div class="table-wrap"><table><tbody id="list-1"></tbody></table></div></div>
            <div class="recipe-card"><div class="card-header"><h2>Adapta√ß√£o</h2><div id="meta-2" style="font-size:7px; color:#cbd5e1;">0 Tratos</div><span id="loss-2" style="font-size:10px; color:#ffbcbc; font-weight:900;">R$ 0</span></div>
            <div class="table-wrap"><table><tbody id="list-2"></tbody></table></div></div>
            <div class="recipe-card"><div class="card-header"><h2>Bezerro</h2><div id="meta-3" style="font-size:7px; color:#cbd5e1;">0 Tratos</div><span id="loss-3" style="font-size:10px; color:#ffbcbc; font-weight:900;">R$ 0</span></div>
            <div class="table-wrap"><table><tbody id="list-3"></tbody></table></div></div>
        </div>

        <div class="chart-section">
            <div style="flex:1; position:relative;"><canvas id="lossChart"></canvas></div>
        </div>

        <div class="assertivity-section">
            <div style="font-size:9px; font-weight: 900; color: var(--sidebar-bg); text-transform: uppercase; margin-bottom: 5px;">üìä Matriz de Cargas por Hor√°rio (%)</div>
            <div class="matrix-scroll">
                <table class="matrix-table">
                    <thead><tr id="matrix-header"><th class="hour-col">HORA</th></tr></thead>
                    <tbody id="matrix-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        let database = [];
        let myChart = null, chartEff = null, chartLoss = null;
        const costs = { 'BAGA√áO DE CANA': 0.10, 'BOLACHA': 0.95, 'SOJA': 1.38, 'MANDIOCA': 0.10, 'LARANJA': 0.06, 'SAL': 3.16, 'UREIA': 2.90 };
        const aliasMap = { 'BAG': 'BAGA√áO DE CANA', 'BOL': 'BOLACHA', 'S': 'SAL', 'M': 'MANDIOCA', 'L': 'LARANJA' };

        function formatBR(v) { return Math.round(v).toLocaleString('pt-BR'); }

        document.getElementById('folder-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.csv'));
            database = [];
            for (const file of files) {
                await new Promise(resolve => { Papa.parse(file, { delimiter: ";", encoding: "ISO-8859-1", skipEmptyLines: true, complete: function(res) { parseFile(res.data); resolve(); } }); });
            }
            if (database.length) clearFilters();
        });

        function parseFile(rows) {
            let recipe = null;
            rows.forEach((row, i) => {
                if (row[0] && row[0].toLowerCase().includes("dados da receita")) {
                    const dr = rows[i+2];
                    if (dr && dr[1]) {
                        let rd = dr[3].toString().trim();
                        if (rd.includes('/')) { const p = rd.split('/'); rd = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                        recipe = { id: dr[1].toString().trim(), date: rd, time: dr[4] || "00:00", items: [], totalLoss: 0, totalP: 0, totalR: 0 };
                    }
                }
                if (row[0] && row[0].toLowerCase().includes("dados dos componentes") && recipe) {
                    let j = i + 2;
                    while (rows[j] && !isNaN(rows[j][0]) && rows[j][0] !== "") {
                        const name = aliasMap[rows[j][1].trim().toUpperCase()] || rows[j][1].trim().toUpperCase();
                        if (costs[name]) {
                            const p = parseFloat(rows[j][2].toString().replace(',','.'))||0, r = parseFloat(rows[j][3].toString().replace(',','.'))||0;
                            recipe.items.push({ name, p, r, diff: Math.abs(r-p), loss: Math.abs(r-p) * costs[name] });
                            recipe.totalLoss += (Math.abs(r-p) * costs[name]);
                            recipe.totalP += p; recipe.totalR += r;
                        }
                        j++;
                    }
                }
            });
            if (recipe && recipe.items.length > 0) database.push(recipe);
        }

        function createGauge(id, val, color) {
            return new Chart(document.getElementById(id), { type: 'doughnut', data: { datasets: [{ data: [val, 100 - Math.min(100, val)], backgroundColor: [color, '#e2e8f0'], borderWidth: 0 }] }, options: { rotation: -90, circumference: 180, cutout: '80%', plugins: { datalabels: { display: false }, tooltip: { enabled: false } }, animation: { duration: 500 } } });
        }

        function render() {
            const single = document.getElementById('date-single').value;
            const start = document.getElementById('date-start').value, end = document.getElementById('date-end').value;
            let filtered = single ? database.filter(d => d.date === single) : database.filter(d => d.date >= start && d.date <= end);

            let gLoss = 0, eSum = 0, eCount = 0;
            const daily = {}, activeHours = new Set();

            [1,2,3].forEach(id => {
                const tr = filtered.filter(f => parseInt(f.id) === id);
                let rLoss = 0; const iTotals = {};
                tr.forEach(t => {
                    rLoss += t.totalLoss; gLoss += t.totalLoss;
                    if(!daily[t.date]) daily[t.date] = { loss: 0, count: 0, hours: {} };
                    daily[t.date].loss += t.totalLoss; daily[t.date].count++;
                    const h = parseInt(t.time.split(':')[0]); activeHours.add(h);
                    const efic = t.totalP > 0 ? Math.max(0, 100 - (Math.abs(t.totalR - t.totalP) / t.totalP * 100)) : 0;
                    daily[t.date].hours[h] = { perc: efic, time: t.time.replace('.', ':') };
                    t.items.forEach(it => {
                        if(!iTotals[it.name]) iTotals[it.name] = { p: 0, r: 0, d: 0, l: 0 };
                        iTotals[it.name].p += it.p; iTotals[it.name].r += it.r; iTotals[it.name].d += it.diff; iTotals[it.name].l += it.loss;
                    });
                });
                document.getElementById(`meta-${id}`).innerText = `${tr.length} Tratos`;
                document.getElementById(`loss-${id}`).innerText = `R$ ${formatBR(rLoss)}`;
                document.getElementById(`list-${id}`).innerHTML = Object.keys(iTotals).sort().map(n => {
                    const d = iTotals[n], efic = d.p > 0 ? Math.max(0, 100-(d.d/d.p*100)) : 0;
                    eSum += efic; eCount++;
                    return `<tr><td>${n.split(' ')[0]}</td><td>P:${formatBR(d.p)}</td><td>R:${formatBR(d.r)}</td><td class="c-red">R$${formatBR(d.l)}</td><td class="${efic >= 95 ? 'c-green' : (efic >= 90 ? '' : 'c-red')}">${Math.round(efic)}%</td></tr>`;
                }).join('');
            });

            const avgE = eCount > 0 ? Math.round(eSum/eCount) : 0;
            if(chartEff) chartEff.destroy(); chartEff = createGauge('gaugeEff', avgE, avgE >= 95 ? '#3b82f6':'#ef4444');
            document.getElementById('valEff').innerText = avgE+'%';
            if(chartLoss) chartLoss.destroy(); chartLoss = createGauge('gaugeLoss', (gLoss/2000)*100, '#ef4444');
            document.getElementById('valLoss').innerText = 'R$ '+formatBR(gLoss);

            const sortedDates = Object.keys(daily).sort();
            document.getElementById('matrix-header').innerHTML = '<th class="hour-col">HORA</th>' + sortedDates.map(d => `<th>${d.split('-').reverse().slice(0,2).join('/')}</th>`).join('');
            
            const sortedHours = Array.from(activeHours).sort((a, b) => a - b);
            let matrixHTML = '';
            sortedHours.forEach(h => {
                const hLabel = h < 10 ? `0${h}:00H` : `${h}:00H`;
                matrixHTML += `<tr><td class="hour-col">${hLabel}</td>`;
                sortedDates.forEach(d => {
                    const data = daily[d].hours[h];
                    if(data){
                        const cls = data.perc >= 95 ? 'cell-high' : (data.perc >= 90 ? 'cell-mid' : 'cell-low');
                        matrixHTML += `<td class="${cls}">${Math.round(data.perc)}%<br/><span style="font-size:5px; opacity:0.8">${data.time}</span></td>`;
                    } else { matrixHTML += `<td style="color:#eee">-</td>`; }
                });
                matrixHTML += `</tr>`;
            });
            document.getElementById('matrix-body').innerHTML = matrixHTML;

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('lossChart'), {
                type: 'bar',
                data: { labels: sortedDates.map(d => d.split('-').reverse().join('/')), datasets: [{ data: sortedDates.map(d => daily[d].loss), backgroundColor: '#ef4444', borderRadius: 4 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v, c) => `R$${formatBR(v)}\n(${daily[sortedDates[c.dataIndex]].count} Tr.)`, font: { size: 7, weight: 'bold' }, textAlign: 'center' } }, scales: { y: { display: false, beginAtZero: true }, x: { grid: { display: false }, ticks: { font: { size: 8 } } } } }
            });
        }

        function clearFilters() { const dates = database.map(d => d.date).sort(); document.getElementById('date-single').value = ""; document.getElementById('date-start').value = dates[0]; document.getElementById('date-end').value = dates[dates.length-1]; render(); }
        function applySingleDate() { document.getElementById('date-start').value = ""; document.getElementById('date-end').value = ""; render(); }
        function applyRangeDate() { document.getElementById('date-single').value = ""; render(); }
    </script>
</body>
</html>
