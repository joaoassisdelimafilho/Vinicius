<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S√≠tio S√£o Sebasti√£o - Importa√ß√£o</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #020617; background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .admin-card { background: rgba(15, 23, 42, 0.9); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; text-align: center; backdrop-filter: blur(20px); }
        h2 { font-size: 16px; font-weight: 800; color: #3b82f6; text-transform: uppercase; margin-bottom: 20px; }
        input { width: 100%; height: 48px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; padding: 0 15px; margin-bottom: 12px; box-sizing: border-box; outline: none; font-size: 14px; }
        .drop-zone { border: 2px dashed rgba(59, 130, 246, 0.4); padding: 30px; border-radius: 16px; cursor: pointer; margin: 15px 0; background: rgba(59, 130, 246, 0.05); transition: 0.3s; }
        .drop-zone:hover { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
        .btn-process { width: 100%; height: 50px; background: #3b82f6; border: none; border-radius: 12px; color: white; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .btn-process:active { transform: scale(0.98); }
        #status { margin-top: 15px; font-size: 12px; font-weight: 600; }
        .link-back { color: #64748b; text-decoration: none; font-size: 10px; display: block; margin-top: 20px; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="admin-card">
    <img src="imagen.png" style="width:100px; mix-blend-mode:lighten; margin-bottom:10px;">
    <h2>Sincronizar DG500</h2>
    
    <div id="auth-area">
        <input type="email" id="email" placeholder="E-mail do Administrador">
        <input type="password" id="pass" placeholder="Senha">
    </div>

    <div class="drop-zone" onclick="document.getElementById('file-input').click()">
        <span id="label">Selecionar Pasta da Balan√ßa</span>
        <input type="file" id="file-input" multiple webkitdirectory directory style="display:none;">
    </div>

    <button class="btn-process" onclick="handleImport()">Sincronizar Banco de Dados</button>
    
    <div id="status"></div>
    <a href="index.html" class="link-back">‚Üê Voltar ao Dashboard</a>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBP_0G13P-jJAaZe0XFi_0Mtp3l02-cAc4", 
        authDomain: "fazenda-e5e25.firebaseapp.com", 
        projectId: "fazenda-e5e25", 
        storageBucket: "fazenda-e5e25.firebasestorage.app", 
        messagingSenderId: "531227081563", 
        appId: "1:531227081563:web:391f17caa7e7be090d387e" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.getElementById('file-input').addEventListener('change', e => {
        const count = e.target.files.length;
        document.getElementById('label').innerText = count > 0 ? count + " arquivos prontos" : "Selecionar Pasta da Balan√ßa";
    });

    async function handleImport() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const files = document.getElementById('file-input').files;
        const status = document.getElementById('status');

        if (!email || !pass || files.length === 0) {
            status.innerHTML = "‚ùå Preencha o login e selecione a pasta.";
            return;
        }

        status.innerHTML = "‚è≥ Autenticando...";

        try {
            await auth.signInWithEmailAndPassword(email, pass);
            status.innerHTML = "üöÄ Processando arquivos...";
            
            let totalProcessed = 0;

            for (let file of files) {
                if (!file.name.endsWith('.csv')) continue;

                const text = await file.text();
                const lines = text.split('\n');
                const batch = db.batch();

                // L√≥gica para processar as colunas do CSV
                for (let i = 1; i < lines.length; i++) {
                    const col = lines[i].split(',');
                    if (col.length < 5) continue;

                    const docRef = db.collection("auditoria").doc();
                    batch.set(docRef, {
                        date: col[0].trim(),
                        id: col[1].trim(),
                        totalP: parseFloat(col[3]) || 0,
                        totalR: parseFloat(col[4]) || 0,
                        totalLoss: (Math.abs(parseFloat(col[3]) - parseFloat(col[4]))) * 1.5, // Exemplo de c√°lculo de custo
                        items: [] 
                    });
                }
                await batch.commit();
                totalProcessed++;
                status.innerHTML = `‚è≥ ${totalProcessed} de ${files.length} arquivos sincronizados...`;
            }

            status.innerHTML = "‚úÖ TUDO PRONTO! Dashboard atualizado.";
            setTimeout(() => window.location.href = "index.html", 2000);

        } catch (error) {
            status.innerHTML = "‚ùå Falha no login ou erro de rede.";
            console.error(error);
        }
    }
</script>

</body>
</html>
