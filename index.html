<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sítio São Sebastião - Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #3b82f6; 
            --danger: #ef4444; 
            --success: #10b981; 
            --glass: rgba(15, 23, 42, 0.8); 
            --border: rgba(255, 255, 255, 0.1); 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: #020617; 
            background-image: radial-gradient(circle at 50% -20%, rgba(59, 130, 246, 0.15), transparent), url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); 
            background-attachment: fixed;
            margin: 0; color: #f8fafc; padding-bottom: 80px;
        }

        .container { padding: 15px; max-width: 1200px; margin: 0 auto; }

        /* HEADER ALINHADO */
        .main-header-card { 
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            padding: 20px; border-radius: 24px; border: 1px solid var(--border); 
            margin-top: 10px; margin-bottom: 20px;
            display: flex; align-items: center; min-height: 110px;
        }

        .logo-area { flex: 0 0 85px; height: 85px; display: flex; align-items: center; justify-content: center; mix-blend-mode: lighten; margin-right: 20px; }
        .logo-area img { max-width: 100%; max-height: 100%; display: block; }

        .filters-container { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .filter-group { display: flex; flex-direction: column; justify-content: center; }
        .filter-group label { font-size: 7px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        
        input, .btn-nav { height: 38px; border-radius: 10px; font-size: 11px; width: 100%; box-sizing: border-box; -webkit-appearance: none; }
        input { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 0 8px; outline: none; }
        .btn-nav { background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); color: white; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; justify-content: center; margin-top: 11px; }

        /* KPIs SIMÉTRICOS */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card-kpi { 
            background: var(--glass); padding: 15px; border-radius: 20px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; height: 125px; box-sizing: border-box;
            justify-content: space-between;
        }
        .card-kpi label { font-size: 8px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .kpi-value { font-size: 24px; font-weight: 900; display: flex; align-items: baseline; gap: 3px; }
        .meta-progress { background: rgba(255,255,255,0.05); height: 8px; border-radius: 10px; position: relative; width: 100%; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width 1s ease-in-out; }
        .meta-target-marker { position: absolute; left: 95%; top: -4px; width: 2px; height: 16px; background: var(--success); z-index: 5; box-shadow: 0 0 10px var(--success); }

        /* DESIGN ORIGINAL DAS RECEITAS (RESTAURADO) */
        .audit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; -webkit-overflow-scrolling: touch; }
        .recipe-card { min-width: 320px; flex: 1; background: var(--glass); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
        .recipe-header { background: rgba(0,0,0,0.4); padding: 18px; text-align: center; }
        .recipe-header h3 { margin: 0; font-size: 14px; font-weight: 900; text-transform: uppercase; color: var(--accent); }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { padding: 14px 5px; color: #64748b; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 16px 5px; border-bottom: 1px solid rgba(255,255,255,0.02); text-align: center; font-weight: 600; color: #e2e8f0; }

        /* GRÁFICO NO FINAL */
        .chart-card { background: var(--glass); padding: 25px; border-radius: 28px; border: 1px solid var(--border); margin-top: 10px; }
        .chart-inner-box { min-width: 600px; height: 320px; }

        .footer-area { margin-top: 30px; text-align: center; }
        .btn-logout { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #64748b; padding: 10px 40px; border-radius: 50px; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; }

        .loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#020617; display:flex; justify-content:center; align-items:center; z-index:2000; font-weight:900; color: var(--accent); }
    </style>
</head>
<body>

<div id="loading" class="loading-screen">SÍTIO SÃO SEBASTIÃO...</div>

<div class="container">
    <div class="main-header-card">
        <div class="logo-area"><img src="imagen.png" alt="Logo"></div>
        <div class="filters-container">
            <div class="filter-group"><label>Início</label><input type="date" id="date-start" onchange="renderWithFilters()"></div>
            <div class="filter-group"><label>Dia Único</label><input type="date" id="date-single" onchange="renderWithFilters()"></div>
            <div class="filter-group"><label>Fim</label><input type="date" id="date-end" onchange="renderWithFilters()"></div>
            <div class="filter-group"><button class="btn-nav" onclick="clearFilters()">LIMPAR</button></div>
        </div>
    </div>

    <div class="kpi-row">
        <div class="card-kpi">
            <label>Precisão Dieta (Meta 95%)</label>
            <div class="kpi-value"><span id="avg-eff">0%</span></div>
            <div class="meta-progress">
                <div class="meta-target-marker"></div>
                <div id="bar-eff" class="bar-fill"></div>
            </div>
        </div>
        <div class="card-kpi">
            <label>Disperdício Total</label>
            <div class="kpi-value" style="color:var(--danger)">
                <small style="font-size:14px; margin-right:2px">R$</small>
                <span id="total-loss">0</span>
            </div>
            <div class="meta-progress">
                <div id="bar-loss" class="bar-fill" style="background:var(--danger)"></div>
            </div>
        </div>
    </div>

    <div class="audit-scroll" id="audit-container"></div>

    <div class="chart-card">
        <label style="font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 10px;">Histórico de Conformidade</label>
        <div style="overflow-x: auto;">
            <div class="chart-inner-box"><canvas id="performanceChart"></canvas></div>
        </div>
    </div>

    <div class="footer-area">
        <button class="btn-logout" onclick="logout()">Encerrar Sessão</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBP_0G13P-jJAaZe0XFi_0Mtp3l02-cAc4", authDomain: "fazenda-e5e25.firebaseapp.com", projectId: "fazenda-e5e25", storageBucket: "fazenda-e5e25.firebasestorage.app", messagingSenderId: "531227081563", appId: "1:531227081563:web:391f17caa7e7be090d387e" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let globalData = [];
    let performanceChart = null;

    firebase.auth().onAuthStateChanged(user => { if (!user) { window.location.href = "login.html"; } else { loadData(); } });

    async function loadData() { try { const snapshot = await db.collection("auditoria").orderBy("date", "desc").limit(300).get(); globalData = []; snapshot.forEach(doc => globalData.push(doc.data())); renderWithFilters(); document.getElementById('loading').style.display = 'none'; } catch (e) { console.error(e); } }

    function clearFilters() { document.querySelectorAll('input').forEach(i => i.value = ""); renderWithFilters(); }

    function renderWithFilters() { 
        const single = document.getElementById('date-single').value; 
        const start = document.getElementById('date-start').value; 
        const end = document.getElementById('date-end').value; 
        let filtered = globalData; 
        if (single) { filtered = globalData.filter(d => d.date === single); } 
        else if (start && end) { filtered = globalData.filter(d => d.date >= start && d.date <= end); } 
        renderDashboard(filtered); 
    }

    function renderDashboard(data) {
        let gLoss = 0, eSum = 0, eCount = 0;
        const dailyL = {}, dailyE = {};
        const recipeMap = { 1: "ENGORDA", 2: "ADAPTAÇÃO", 3: "BEZERRO" };

        const html = [1, 2, 3].map(id => {
            const tratos = data.filter(d => parseInt(d.id) === id);
            if (tratos.length === 0) return '';
            let rL = 0; const iT = {};
            tratos.forEach(t => {
                rL += (t.totalLoss || 0);
                if(!dailyL[t.date]) { dailyL[t.date] = 0; dailyE[t.date] = []; }
                dailyL[t.date] += (t.totalLoss || 0);
                const efTrato = t.totalP > 0 ? Math.max(0, 100 - (Math.abs(t.totalR - t.totalP) / t.totalP * 100)) : 0;
                dailyE[t.date].push(efTrato);
                t.items.forEach(it => {
                    if(!iT[it.name]) iT[it.name] = { p:0, r:0, d:0, l:0 };
                    iT[it.name].p += it.p; iT[it.name].r += it.r; iT[it.name].d += (it.diff || 0); iT[it.name].l += (it.loss || 0);
                });
            });
            gLoss += rL;
            const rows = Object.keys(iT).sort().map(n => {
                const d = iT[n];
                const ef = d.p > 0 ? Math.max(0, 100 - (d.d / d.p * 100)) : 0;
                eSum += ef; eCount++;
                return `<tr><td>${n.split(' ')[0]}</td><td>${Math.round(d.p)}</td><td>${Math.round(d.r)}</td><td>${Math.round(d.d)}</td><td style="color:${d.l > 0 ? 'var(--danger)' : '#64748b'}">R$${Math.round(d.l)}</td><td style="color:${ef>=95?'var(--success)':'var(--danger)'}">${ef.toFixed(1)}%</td></tr>`;
            }).join('');
            return `<div class="recipe-card"><div class="recipe-header"><h3>${recipeMap[id]}</h3><span style="font-size:18px; font-weight:800; color:#fff;">R$ ${Math.round(rL).toLocaleString('pt-BR')}</span></div><table><thead><tr><th>Item</th><th>Prog</th><th>Real</th><th>Dif</th><th>Custo</th><th>Efic%</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        }).join('');

        document.getElementById('audit-container').innerHTML = html;
        const avgGlobal = eCount > 0 ? (eSum / eCount) : 0;
        document.getElementById('avg-eff').innerText = avgGlobal.toFixed(1) + '%';
        document.getElementById('bar-eff').style.width = avgGlobal + '%';
        document.getElementById('bar-eff').style.background = avgGlobal >= 95 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('total-loss').innerText = Math.round(gLoss).toLocaleString('pt-BR');
        document.getElementById('bar-loss').style.width = Math.min(100, (gLoss/20000)*100) + '%';
        updateChart(dailyL, dailyE);
    }

    function updateChart(dL, dE) {
        const labels = Object.keys(dL).sort();
        if(performanceChart) performanceChart.destroy();
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.map(l => l.split('-').reverse().slice(0,2).join('/')),
                datasets: [
                    { label: 'Precisão', data: labels.map(l => dE[l].reduce((a,b)=>a+b,0)/dE[l].length), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                    { label: 'Meta', data: labels.map(() => 95), borderColor: 'rgba(16, 185, 129, 0.4)', borderDash: [5, 5], pointRadius: 0 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 60, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } } }
        });
    }
    function logout() { firebase.auth().signOut().then(() => window.location.href = "login.html"); }
</script>
</body>
</html>
