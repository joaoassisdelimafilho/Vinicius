<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashFarm - Monitor Autom√°tico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #0f172a;
            --main-bg: #f1f5f9;
            --accent: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR COMPACTA */
        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .logo h1 { font-size: 18px; font-weight: 800; margin: 0; color: var(--accent); }
        .logo p { font-size: 10px; margin: 2px 0 0; color: #94a3b8; text-transform: uppercase; }

        .upload-area {
            background: #1e293b;
            border: 1px dashed #334155;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        .upload-label { font-size: 11px; font-weight: 600; color: #cbd5e1; }

        .filter-item { display: flex; flex-direction: column; gap: 4px; }
        .filter-item label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }

        input[type="date"], select {
            background: #1e293b; border: 1px solid #334155; color: white;
            padding: 8px; border-radius: 6px; font-size: 12px; width: 100%; box-sizing: border-box;
            cursor: pointer;
        }

        /* CONTE√öDO PRINCIPAL */
        .main-content {
            flex: 1;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .header-content h2 { font-size: 20px; margin: 0; font-weight: 800; color: var(--sidebar-bg); }

        /* GRID FIXA DE 3 COLUNAS */
        .grid-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            overflow-y: auto;
            padding-bottom: 30px;
        }

        /* CARD COMPACTO */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .card:hover { transform: translateY(-3px); border-color: var(--accent); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .comp-name { font-size: 15px; font-weight: 900; color: var(--sidebar-bg); text-transform: uppercase; }
        
        .acc-badge { font-size: 10px; font-weight: 900; padding: 4px 8px; border-radius: 4px; }
        .acc-good { background: #dcfce7; color: #15803d; }
        .acc-bad { background: #fee2e2; color: #b91c1c; }

        .stat-line { display: flex; justify-content: space-between; align-items: center; }
        .stat-label { font-size: 9px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 13px; font-weight: 700; }

        .diff-container {
            margin-top: 5px; padding-top: 8px; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .diff-val { font-size: 15px; font-weight: 900; }
        .plus { color: var(--danger); }
        .minus { color: var(--accent); }

        /* RODAP√â DO CARD - ARQUIVOS LIDOS */
        .file-origin {
            margin-top: auto;
            padding-top: 8px;
            font-size: 9px;
            color: var(--text-muted);
            line-height: 1.2;
            font-style: italic;
        }

        #status-bar { margin-top: auto; font-size: 10px; font-weight: bold; color: var(--success); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <h1>DashFarm</h1>
            <p>DG500 Precision</p>
        </div>

        <label class="upload-area" for="folder-input">
            <span class="upload-label">üìÅ CARREGAR PASTA</span>
            <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none">
        </label>

        <div class="filters">
            <div class="filter-item">
                <label>In√≠cio</label>
                <input type="date" id="date-start" onchange="render()">
            </div>
            <div class="filter-item">
                <label>Fim</label>
                <input type="date" id="date-end" onchange="render()">
            </div>
            <div class="filter-item">
                <label>Receita</label>
                <select id="recipe-select" onchange="render()"></select>
            </div>
        </div>
        <div id="status-bar">Pronto para ler.</div>
    </div>

    <div class="main-content">
        <div class="header-content">
            <h2 id="main-title">An√°lise de Ingredientes</h2>
            <div id="period-display" style="font-size: 11px; font-weight: bold; color: var(--text-muted);"></div>
        </div>

        <div class="grid-cards" id="cards-container">
            </div>
    </div>

    <script>
        let database = [];
        const ingredientMap = { 'M': 'MANDIOCA', 'L': 'LARANJA' };
        const recipeMap = { '1': 'Trato de Engorda', '2': 'Trato de Adapta√ß√£o', '3': 'Bezerro' };

        document.getElementById('folder-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.csv'));
            database = [];
            for (const file of files) {
                await new Promise(resolve => {
                    Papa.parse(file, {
                        delimiter: ";", encoding: "ISO-8859-1", skipEmptyLines: true,
                        complete: function(res) { parseCSV(res.data, file.name); resolve(); }
                    });
                });
            }
            setupUI();
        });

        function parseCSV(rows, fileName) {
            let recipe = null;
            let section = "NONE";
            rows.forEach((row, i) => {
                if (row[0]?.toLowerCase().includes("dados da receita")) {
                    section = "HEAD";
                    const dr = rows[i+2];
                    if (dr && dr[3]) {
                        const d = dr[3].split('/');
                        recipe = { id: dr[1].trim(), date: `${d[2]}-${d[1].padStart(2,'0')}-${d[0].padStart(2,'0')}`, items: [], fileName: fileName };
                    }
                }
                if (row[0]?.toLowerCase().includes("dados dos componentes")) section = "COMP";
                if (row[0]?.toLowerCase().includes("lote") || row[0]?.toLowerCase().includes("descarga")) section = "STOP";
                
                if (section === "COMP" && recipe && !isNaN(row[0]) && row[0] !== "" && row[1]) {
                    const n = row[1].trim().toUpperCase();
                    recipe.items.push({ 
                        name: ingredientMap[n] || n, 
                        p: parseFloat(row[2].replace(',','.')) || 0, 
                        r: parseFloat(row[3].replace(',','.')) || 0 
                    });
                }
            });
            if (recipe && recipe.items.length > 0) database.push(recipe);
        }

        function setupUI() {
            if (!database.length) return;
            const dates = database.map(d => d.date).sort();
            document.getElementById('date-start').value = dates[0];
            document.getElementById('date-end').value = dates[dates.length - 1];
            
            const ids = [...new Set(database.map(d => d.id))].sort((a,b) => a-b);
            const sel = document.getElementById('recipe-select');
            sel.innerHTML = '<option value="ALL">TODAS AS RECEITAS</option>' + ids.map(id => `<option value="${id}">${id} - ${recipeMap[id] || 'Receita'}</option>`).join('');
            
            render();
            document.getElementById('status-bar').innerText = "Dados carregados.";
        }

        function render() {
            const start = document.getElementById('date-start').value;
            const end = document.getElementById('date-end').value;
            const selId = document.getElementById('recipe-select').value;
            
            if (!start || !end) return;

            const period = `${start.split('-').reverse().join('/')} a ${end.split('-').reverse().join('/')}`;
            document.getElementById('period-display').innerText = period;
            
            let filtered = database.filter(d => d.date >= start && d.date <= end);
            if (selId !== "ALL") filtered = filtered.filter(d => d.id === selId);

            const totals = {};
            filtered.forEach(t => {
                t.items.forEach(item => {
                    if (!totals[item.name]) totals[item.name] = { p: 0, r: 0, files: new Set() };
                    totals[item.name].p += item.p;
                    totals[item.name].r += item.r;
                    totals[item.name].files.add(t.fileName);
                });
            });

            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            
            Object.keys(totals).sort().forEach(name => {
                const d = totals[name];
                const diff = d.r - d.p;
                const acc = d.p > 0 ? Math.max(0, 100 - (Math.abs(diff/d.p)*100)) : 0;
                
                // Formatar lista de arquivos
                const fileList = Array.from(d.files);
                const displayFiles = fileList.slice(0, 5).join(', ') + (fileList.length > 5 ? '...' : '');

                container.innerHTML += `
                    <div class="card">
                        <div class="card-header">
                            <div><span class="comp-name">${name}</span></div>
                            <span class="acc-badge ${acc >= 95 ? 'acc-good' : 'acc-bad'}">${acc.toFixed(1)}% Acertividade</span>
                        </div>
                        <div class="stat-line"><span class="stat-label">Pedido</span><span class="stat-val">${Math.round(d.p).toLocaleString()} kg</span></div>
                        <div class="stat-line"><span class="stat-label">Real</span><span class="stat-val">${Math.round(d.r).toLocaleString()} kg</span></div>
                        <div class="diff-container">
                            <span class="stat-label">Diferen√ßa</span>
                            <span class="diff-val ${diff > 0 ? 'plus' : 'minus'}">${diff > 0 ? '+' : ''}${Math.round(diff).toLocaleString()} kg</span>
                        </div>
                        <div class="file-origin">Origem: ${displayFiles}</div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
