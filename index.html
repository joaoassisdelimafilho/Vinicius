<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sítio São Sebastião - Dashboard Premium</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #3b82f6; --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --glass: rgba(15, 23, 42, 0.85); --border: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Inter', sans-serif; background: #020617; background-image: radial-gradient(circle at 50% -20%, rgba(59, 130, 246, 0.15), transparent), url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); background-attachment: fixed; margin: 0; color: #f8fafc; padding-bottom: 80px; }
        .container { padding: 15px; max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        .main-header-card { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); padding: 20px; border-radius: 24px; border: 1px solid var(--border); margin-top: 10px; margin-bottom: 20px; display: flex; align-items: center; min-height: 110px; }
        .logo-area { flex: 0 0 85px; height: 85px; display: flex; align-items: center; justify-content: center; mix-blend-mode: lighten; margin-right: 20px; }
        .logo-area img { max-width: 100%; max-height: 100%; display: block; }
        .filters-container { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, .btn-nav { height: 38px; border-radius: 10px; font-size: 11px; width: 100%; box-sizing: border-box; }
        input { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 0 8px; outline: none; }
        .btn-nav { background: var(--accent); color: white; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; margin-top: 11px; }

        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card-kpi { background: var(--glass); padding: 18px; border-radius: 24px; border: 1px solid var(--border); display: flex; flex-direction: column; height: 130px; box-sizing: border-box; justify-content: space-between; }
        .kpi-value { font-size: 26px; font-weight: 900; }

        /* RECEITAS */
        .audit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; -webkit-overflow-scrolling: touch; }
        .recipe-card { min-width: 340px; flex: 1; background: var(--glass); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
        .recipe-header { background: rgba(0,0,0,0.4); padding: 15px; text-align: center; }
        .recipe-header h3 { margin: 0; font-size: 14px; font-weight: 900; text-transform: uppercase; color: var(--accent); }
        .recipe-count { font-size: 10px; color: #94a3b8; font-weight: 800; display: block; margin-top: 4px; text-transform: uppercase; }

        /* VELOCÍMETRO SVG CORRIGIDO (VIRADO PARA CIMA) */
        .gauge-container { width: 160px; height: 90px; margin: 10px auto; position: relative; }
        .gauge-bg { fill: none; stroke: #1e293b; stroke-width: 14; }
        .gauge-fill { fill: none; stroke-width: 14; stroke-linecap: round; transition: stroke-dashoffset 1.5s ease-out, stroke 1s; }
        .gauge-text-center { position: absolute; bottom: 5px; width: 100%; text-align: center; font-weight: 900; font-size: 26px; color: #fff; }

        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { padding: 12px 4px; color: #64748b; font-weight: 800; border-bottom: 1px solid var(--border); }
        td { padding: 14px 4px; border-bottom: 1px solid rgba(255,255,255,0.02); text-align: center; font-weight: 600; color: #e2e8f0; }

        .chart-card { background: var(--glass); padding: 25px; border-radius: 28px; border: 1px solid var(--border); margin-top: 10px; }
        .chart-inner-box { min-width: 600px; height: 320px; }
        .footer-area { margin-top: 30px; text-align: center; }
        .btn-logout { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #64748b; padding: 10px 40px; border-radius: 50px; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-header-card">
        <div class="logo-area"><img src="imagen.png" alt="Logo"></div>
        <div class="filters-container">
            <div class="filter-group"><label>Início</label><input type="date" id="date-start" onchange="loadData()"></div>
            <div class="filter-group"><label>Fim</label><input type="date" id="date-end" onchange="loadData()"></div>
            <button class="btn-nav" style="grid-column: span 2;" onclick="location.reload()">LIMPAR FILTROS</button>
        </div>
    </div>

    <div class="kpi-row">
        <div class="card-kpi">
            <label>Eficiência Média (Meta 95%)</label>
            <div class="kpi-value" id="avg-eff">0%</div>
            <div style="background: rgba(255,255,255,0.05); height: 8px; border-radius: 10px; overflow: hidden; position: relative;">
                <div style="position: absolute; left: 95%; top: 0; width: 2px; height: 100%; background: var(--success); z-index: 10;"></div>
                <div id="bar-eff" style="height: 100%; transition: 1s;"></div>
            </div>
        </div>
        <div class="card-kpi">
            <label>Custo Extra Acumulado</label>
            <div class="kpi-value" style="color:var(--danger)">R$ <span id="total-loss">0</span></div>
            <div style="background: rgba(255,255,255,0.05); height: 8px; border-radius: 10px; overflow: hidden;">
                <div id="bar-loss" style="height: 100%; background: var(--danger); transition: 1s;"></div>
            </div>
        </div>
    </div>

    <div class="audit-scroll" id="audit-container"></div>

    <div class="chart-card">
        <label style="font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 15px;">Evolução de Eficiência (%)</label>
        <div style="overflow-x: auto;"><div class="chart-inner-box"><canvas id="performanceChart"></canvas></div></div>
    </div>

    <div class="footer-area"><button class="btn-logout" onclick="logout()">Encerrar Sessão</button></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBP_0G13P-jJAaZe0XFi_0Mtp3l02-cAc4", authDomain: "fazenda-e5e25.firebaseapp.com", projectId: "fazenda-e5e25", storageBucket: "fazenda-e5e25.firebasestorage.app", messagingSenderId: "531227081563", appId: "1:531227081563:web:391f17caa7e7be090d387e" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let performanceChart = null;

    firebase.auth().onAuthStateChanged(user => { if (user) loadData(); else window.location.href = "login.html"; });

    async function loadData() {
        const snap = await db.collection("auditoria").orderBy("timestamp", "desc").limit(300).get();
        let data = []; snap.forEach(doc => data.push(doc.data()));
        const s = document.getElementById('date-start').value, e = document.getElementById('date-end').value;
        if (s && e) data = data.filter(d => d.date >= s && d.date <= e);
        renderDashboard(data);
    }

    function renderDashboard(data) {
        let gLoss = 0, eSum = 0, eCount = 0;
        const dailyEff = {};
        const recipeMap = { 1: "ENGORDA", 2: "ADAPTAÇÃO", 3: "BEZERRO" };
        const container = document.getElementById('audit-container');
        container.innerHTML = "";

        [1, 2, 3].forEach(id => {
            const tratos = data.filter(d => parseInt(d.id) === id);
            if (tratos.length === 0) return;

            let rL = 0, rP = 0, rR = 0; const iT = {};
            tratos.forEach(t => {
                rL += (t.totalLoss || 0); rP += (t.totalP || 0); rR += (t.totalR || 0);
                const efVal = t.totalP > 0 ? Math.max(0, 100 - (Math.abs(t.totalP - t.totalR)/t.totalP*100)) : 0;
                if(!dailyEff[t.date]) dailyEff[t.date] = []; dailyEff[t.date].push(efVal);
                if(t.items) t.items.forEach(it => {
                    if(!iT[it.name]) iT[it.name] = { p:0, r:0, d:0, l:0 };
                    iT[it.name].p += it.p; iT[it.name].r += it.r; iT[it.name].d += it.diff; iT[it.name].l += it.loss;
                });
            });

            gLoss += rL;
            const recipeEff = rP > 0 ? Math.max(0, 100 - (Math.abs(rP - rR) / rP * 100)) : 0;
            eSum += recipeEff; eCount++;

            const rows = Object.keys(iT).map(n => {
                const d = iT[n], ef = d.p > 0 ? Math.max(0, 100 - (d.d / d.p * 100)) : 0;
                return `<tr><td style="text-align:left;">${n}</td><td>${Math.round(d.r)}</td><td>${Math.round(d.p)}</td><td>${Math.round(d.d)}</td><td style="color:var(--danger)">R$${Math.round(d.l)}</td><td style="color:${ef>=95?'var(--success)':'var(--danger)'}">${ef.toFixed(1)}%</td></tr>`;
            }).join('');

            // ARCO CORRIGIDO: Circunferência total de um meio círculo é PI * Raio (aprox 220)
            const circumference = 220; 
            const offset = circumference - (recipeEff / 100) * circumference;
            const color = recipeEff >= 95 ? 'var(--success)' : (recipeEff >= 80 ? 'var(--warning)' : 'var(--danger)');

            container.innerHTML += `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <h3>${recipeMap[id]}</h3>
                        <span class="recipe-count">${tratos.length} RECEITAS REALIZADAS</span>
                        <div class="gauge-container">
                            <svg width="160" height="85" viewBox="0 0 160 85">
                                <path class="gauge-bg" d="M 10 80 A 70 70 0 0 1 150 80" />
                                <path class="gauge-fill" d="M 10 80 A 70 70 0 0 1 150 80" 
                                      style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}; stroke: ${color};" />
                            </svg>
                            <div class="gauge-text-center">${Math.round(recipeEff)}%</div>
                        </div>
                        <div style="font-size:22px; font-weight:900; color:#fff;">R$ ${Math.round(rL).toLocaleString('pt-BR')}</div>
                    </div>
                    <table>
                        <thead><tr><th style="text-align:left;">Item</th><th>Real</th><th>Prog</th><th>Dif</th><th>Valor</th><th>Efic%</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        });

        const finalEff = eCount > 0 ? (eSum / eCount) : 0;
        document.getElementById('avg-eff').innerText = finalEff.toFixed(1) + '%';
        document.getElementById('bar-eff').style.width = finalEff + '%';
        document.getElementById('bar-eff').style.background = finalEff >= 95 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('total-loss').innerText = Math.round(gLoss).toLocaleString('pt-BR');
        document.getElementById('bar-loss').style.width = Math.min(100, (gLoss/25000)*100) + '%';
        updateChart(dailyEff);
    }

    function updateChart(dailyEff) {
        const dates = Object.keys(dailyEff).sort();
        const vals = dates.map(d => dailyEff[d].reduce((a,b)=>a+b,0) / dailyEff[d].length);
        if(performanceChart) performanceChart.destroy();
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: dates.map(d => d.split('-').reverse().slice(0,2).join('/')), 
                datasets: [
                    { label: 'Eficiência %', data: vals, borderColor: '#3b82f6', tension: 0.3, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                    { label: 'Meta 95%', data: dates.map(() => 95), borderColor: 'rgba(16, 185, 129, 0.5)', borderDash: [5, 5], pointRadius: 0 }
                ] 
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 50, max: 100 } } }
        });
    }
    function logout() { firebase.auth().signOut().then(() => window.location.href = "login.html"); }
</script>
</body>
</html>
